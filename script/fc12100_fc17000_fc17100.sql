SET HEADING OFF;

SELECT
  COALESCE(FC12100.CDFIL, 'N/A') || ',' ||
  COALESCE(FC12100.NRRQU, 'N/A') || ',' ||
  COALESCE(FC12100.NRCRM, 'N/A') || ',' ||
  COALESCE(FC12100.NOMEPA, 'N/A') || ',' ||
  COALESCE(FC12100.DTENTR, 'N/A') || ',' ||
  COALESCE(FC12100.INDREPET, 'N') || ',' ||
  COALESCE(FC12100.NUMRGR, 'N/A') || ',' ||
  COALESCE(FC12100.CDFILE, 'N/A') || ',' ||
  COALESCE(FC12100.CDFUNRE, 'N/A') || ',' ||

  COALESCE(FC17000.VRRQU, '0.0') || ',' ||
  COALESCE(FC17000.VRDSC, '0.0') || ',' ||
  COALESCE(FC17000.VRTXA, '0.0') || ',' ||

  COALESCE(FC17100.DTPAG, 'N/A') || ',' ||
  COALESCE(FC17100.SOMA_RCB_TAXA, '0.0')
FROM FC12100
LEFT JOIN FC17000
  ON FC12100.CDFIL = FC17000.CDFIL AND FC12100.NRRQU = FC17000.NRRQU
  AND FC17000.DTPAG BETWEEN '2025-04-01' AND '2025-04-30'
LEFT JOIN (
  SELECT
    CDFIL,
    NRRQU,
    MAX(DTPAG) AS DTPAG,
    SUM(VRRCB - VRTXA) AS SOMA_RCB_TAXA
  FROM FC17100
  WHERE DTOPE BETWEEN '2025-04-01' AND '2025-04-30'
  GROUP BY CDFIL, NRRQU
) FC17100
  ON FC12100.CDFIL = FC17100.CDFIL AND FC12100.NRRQU = FC17100.NRRQU
WHERE FC12100.DTENTR BETWEEN '2025-04-01' AND '2025-04-30';
