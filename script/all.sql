SET HEADING OFF;

SELECT
  COALESCE(NULLIF(TRIM(FC12100.CDFIL), ''), 'N/A') || ',' ||
  COALESCE(NULLIF(TRIM(FC12100.NRRQU), ''), 'N/A') || ',' ||
  REPLACE(REPLACE(REPLACE(COALESCE(NULLIF(TRIM(FC12100.NOMEPA), ''), 'N/A'), ASCII_CHAR(10), ' '), ASCII_CHAR(13), ' '), ASCII_CHAR(9), ' ') || ',' ||
  COALESCE(NULLIF(TRIM(FC12100.DTENTR), ''), 'N/A') || ',' ||
  COALESCE(NULLIF(TRIM(FC12100.INDREPET), ''), 'N') || ',' ||

  COALESCE(NULLIF(TRIM(FC17000.VRRQU), ''), '0.0') || ',' ||
  COALESCE(NULLIF(TRIM(FC17000.VRDSC), ''), '0.0') || ',' ||
  COALESCE(NULLIF(TRIM(FC17000.VRTXA), ''), '0.0') || ',' ||

  COALESCE(NULLIF(TRIM(FC17100.DTPAG), ''), 'N/A') || ',' ||
  COALESCE(NULLIF(TRIM(FC17100.SOMA_RCB_TAXA), ''), '0.0') || ',' ||

  COALESCE(NULLIF(TRIM(FC04000.PFCRM), ''), 'N/A') || ',' ||
  COALESCE(NULLIF(TRIM(FC04000.UFCRM), ''), 'N/A') || ',' ||
  COALESCE(NULLIF(TRIM(FC04000.NRCRM), ''), 'N/A') || ',' ||
  REPLACE(REPLACE(REPLACE(COALESCE(NULLIF(TRIM(FC04000.NOMEMED), ''), 'SN'), ASCII_CHAR(10), ' '), ASCII_CHAR(13), ' '), ASCII_CHAR(9), ' ') || ',' ||
  COALESCE(NULLIF(TRIM(FC04000.OBSERV), ''), 'N/A') || ',' ||

  COALESCE(NULLIF(TRIM(FC04200.CDFUN), ''), 'N/A') || ',' ||
  COALESCE(NULLIF(TRIM(FC04400.ENDER), ''), 'N/A') || ',' ||
  COALESCE(NULLIF(TRIM(FC04400.ENDNR), ''), '0') || ',' ||
  COALESCE(NULLIF(TRIM(FC04400.ENDCP), ''), 'N/A') || ',' ||
  COALESCE(NULLIF(TRIM(FC04400.BAIRR), ''), 'N/A') || ',' ||
  COALESCE(NULLIF(TRIM(FC04400.NRCEP), ''), '00000-000') || ',' ||
  COALESCE(NULLIF(TRIM(FC04400.MUNIC), ''), 'N/A') || ',' ||
  COALESCE(NULLIF(TRIM(FC04400.UNFED), ''), 'SP') || ',' ||
  COALESCE(NULLIF(TRIM(FC04400.NRDDD), ''), '11') || ',' ||
  COALESCE(NULLIF(TRIM(FC04400.NRTEL), ''), '00000-0000') || ',' ||
  COALESCE(NULLIF(TRIM(FC04400.NRDDD2), ''), '11') || ',' ||
  COALESCE(NULLIF(TRIM(FC04400.NRTEL2), ''), '00000-0000')
FROM FC12100

LEFT JOIN FC17000
  ON FC12100.CDFIL = FC17000.CDFIL
 AND FC12100.NRRQU = FC17000.NRRQU
 AND FC17000.DTPAG BETWEEN '${START_DATE}' AND '${END_DATE}'

LEFT JOIN (
  SELECT
    CDFIL,
    NRRQU,
    MAX(DTPAG) AS DTPAG,
    SUM(VRRCB - VRTXA) AS SOMA_RCB_TAXA
  FROM FC17100
  WHERE DTOPE BETWEEN '${START_DATE}' AND '${END_DATE}'
  GROUP BY CDFIL, NRRQU
) FC17100
  ON FC12100.CDFIL = FC17100.CDFIL
 AND FC12100.NRRQU = FC17100.NRRQU

INNER JOIN FC04000
  ON FC12100.NRCRM = FC04000.NRCRM

LEFT JOIN FC04200
  ON FC04000.PFCRM = FC04200.PFCRM
 AND FC04000.UFCRM = FC04200.UFCRM
 AND FC04000.NRCRM = FC04200.NRCRM

LEFT JOIN FC04400
  ON FC04000.PFCRM = FC04400.PFCRM
 AND FC04000.UFCRM = FC04400.UFCRM
 AND FC04000.NRCRM = FC04400.NRCRM

WHERE FC12100.DTENTR BETWEEN '${START_DATE}' AND '${END_DATE}'
  AND COALESCE(NULLIF(TRIM(FC04200.CDFUN), ''), NULL) IS NOT NULL

GROUP BY
  FC12100.CDFIL, FC12100.NRRQU, FC12100.NOMEPA, FC12100.DTENTR, FC12100.INDREPET,
  FC17000.VRRQU, FC17000.VRDSC, FC17000.VRTXA,
  FC17100.DTPAG, FC17100.SOMA_RCB_TAXA,
  FC04000.PFCRM, FC04000.UFCRM, FC04000.NRCRM, FC04000.NOMEMED, FC04000.OBSERV,
  FC04200.CDFUN,
  FC04400.ENDER, FC04400.ENDNR, FC04400.ENDCP, FC04400.BAIRR, FC04400.NRCEP, FC04400.MUNIC,
  FC04400.UNFED, FC04400.NRDDD, FC04400.NRTEL, FC04400.NRDDD2, FC04400.NRTEL2

ORDER BY FC12100.NRRQU;
