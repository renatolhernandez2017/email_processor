SET HEADING OFF;

SELECT
  COALESCE(NULLIF(TRIM(fc121.CDFIL), ''), 'N/A') || ',' ||
  COALESCE(NULLIF(TRIM(fc121.NRRQU), ''), 'N/A') || ',"' ||
  REPLACE(REPLACE(REPLACE(COALESCE(NULLIF(TRIM(fc121.NOMEPA), ''), 'N/A'), ASCII_CHAR(10), ' '), ASCII_CHAR(13), ' '), ASCII_CHAR(9), ' ') || '",' ||
  COALESCE(NULLIF(TRIM(fc121.DTENTR), ''), 'N/A') || ',' ||
  COALESCE(NULLIF(TRIM(fc121.INDREPET), ''), 'N') || ',' ||

  COALESCE(NULLIF(TRIM(fc170.VRRQU), ''), '0.0') || ',' ||
  COALESCE(NULLIF(TRIM(fc170.VRDSC), ''), '0.0') || ',' ||
  COALESCE(NULLIF(TRIM(fc170.VRTXA), ''), '0.0') || ',' ||

  COALESCE(NULLIF(TRIM(fc171.DTPAG), ''), 'N/A') || ',' ||
  COALESCE(NULLIF(TRIM(fc171.SOMA_RCB_TAXA), ''), '0.0') || ',' ||

  COALESCE(NULLIF(TRIM(fc040.PFCRM), ''), 'N/A') || ',' ||
  COALESCE(NULLIF(TRIM(fc040.UFCRM), ''), 'N/A') || ',' ||
  COALESCE(NULLIF(TRIM(fc040.NRCRM), ''), 'N/A') || ',"' ||
  REPLACE(REPLACE(REPLACE(COALESCE(NULLIF(TRIM(fc040.NOMEMED), ''), 'SN'), ASCII_CHAR(10), ' '), ASCII_CHAR(13), ' '), ASCII_CHAR(9), ' ') || '","' ||
  COALESCE(NULLIF(TRIM(fc040.OBSERV), ''), 'N/A') || '","' ||

  COALESCE(NULLIF(TRIM(fc042.CDFUN), ''), '999') || '","' ||
  COALESCE(NULLIF(TRIM(fc044.ENDER), ''), 'N/A') || '","' ||
  COALESCE(NULLIF(TRIM(fc044.ENDNR), ''), '0') || '","' ||
  COALESCE(NULLIF(TRIM(fc044.ENDCP), ''), 'N/A') || '","' ||
  COALESCE(NULLIF(TRIM(fc044.BAIRR), ''), 'N/A') || '","' ||
  COALESCE(NULLIF(TRIM(fc044.NRCEP), ''), '00000-000') || '","' ||
  COALESCE(NULLIF(TRIM(fc044.MUNIC), ''), 'N/A') || '","' ||
  COALESCE(NULLIF(TRIM(fc044.UNFED), ''), 'SP') || '","' ||
  COALESCE(NULLIF(TRIM(fc044.NRDDD), ''), '11') || '","' ||
  COALESCE(NULLIF(TRIM(fc044.NRTEL), ''), '00000-0000') || '","' ||
  COALESCE(NULLIF(TRIM(fc044.NRDDD2), ''), '11') || '",' ||
  COALESCE(NULLIF(TRIM(fc044.NRTEL2), ''), '00000-0000')

FROM FC12100 fc121

LEFT JOIN FC17000 fc170
  ON fc121.CDFIL = fc170.CDFIL
 AND fc121.NRRQU = fc170.NRRQU
 AND fc170.DTENTR BETWEEN '${START_DATE}' AND '${END_DATE}'

LEFT JOIN (
  SELECT
    CDFIL,
    NRRQU,
    MAX(DTOPE) AS DTPAG,
    SUM(VRRCB - VRTXA) AS SOMA_RCB_TAXA
  FROM FC17100
  WHERE DTOPE BETWEEN '${START_DATE}' AND '${END_DATE}'
  GROUP BY CDFIL, NRRQU
) fc171
  ON fc121.CDFIL = fc171.CDFIL
 AND fc121.NRRQU = fc171.NRRQU

INNER JOIN FC04000 fc040
  ON fc121.NRCRM = fc040.NRCRM

LEFT JOIN FC04200 fc042
  ON fc040.PFCRM = fc042.PFCRM
 AND fc040.UFCRM = fc042.UFCRM
 AND fc040.NRCRM = fc042.NRCRM

LEFT JOIN FC04400 fc044
  ON fc040.PFCRM = fc044.PFCRM
 AND fc040.UFCRM = fc044.UFCRM
 AND fc040.NRCRM = fc044.NRCRM

WHERE fc121.DTENTR BETWEEN '${START_DATE}' AND '${END_DATE}'
AND COALESCE(NULLIF(TRIM(fc042.CDFUN), ''), NULL) IS NOT NULL

GROUP BY
  fc121.CDFIL, fc121.NRRQU, fc121.NOMEPA, fc121.DTENTR, fc121.INDREPET,
  fc170.VRRQU, fc170.VRDSC, fc170.VRTXA,
  fc171.DTPAG, fc171.SOMA_RCB_TAXA,
  fc040.PFCRM, fc040.UFCRM, fc040.NRCRM, fc040.NOMEMED, fc040.OBSERV,
  fc042.CDFUN,
  fc044.ENDER, fc044.ENDNR, fc044.ENDCP, fc044.BAIRR, fc044.NRCEP, fc044.MUNIC,
  fc044.UNFED, fc044.NRDDD, fc044.NRTEL, fc044.NRDDD2, fc044.NRTEL2

ORDER BY fc121.NRRQU;
